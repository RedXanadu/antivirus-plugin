# OWASP CRS Plugin
# Plugin name: antivirus-plugin
# Plugin description: Antivirus software support for CRS.
# Rule ID block base: 9,502,000 - 9,502,999
# Plugin version: 1.0.0
#
# Currently, only ClamAV antivirus is supported.
#
# Prerequisities for this feature:
# - Lua support must be enabled
# - Library lua-socket must be installed in the system
# - modsecurity 'SecTmpSaveUploadedFiles' directive is 'On' or
#   the 'SecUploadKeepFiles' directive is set to either
#   'RelevantOnly' or 'On'
#
# By default, only uploaded files are scanned for viruses. If you
# want to scan also data send by POST/PUT requests (REQUEST_BODY),
# set 'tx.antivirus-plugin_scan_request_body' to 1.
#
# With setting 'tx.antivirus-plugin_clamav_connect_type' you can choose
# between two connection types:
# - tcp: connect using TCP/IP protocol
# - socket: connect using unix socket file
#
# Make sure that setting 'tx.antivirus-plugin_clamav_chunk_size' below
# does not exceed 'StreamMaxLength' as defined in ClamAV
# configuration file clamd.conf.
#
# After enabling, antivirus scanning should be tested, for example,
# using:
# curl http://localhost --form "data=@eicar.com"
# Get eicar test file from https://www.eicar.org.

SecAction \
 "id:9502010,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  ver:'antivirus-plugin/1.0.0',\
  setvar:'tx.antivirus-plugin_enable=1',\
  setvar:'tx.antivirus-plugin_scan_request_body=0',\
  setvar:'tx.antivirus-plugin_clamav_connect_type=socket',\
  setvar:'tx.antivirus-plugin_clamav_socket_file=/var/run/clamav/clamd.ctl',\
  setvar:'tx.antivirus-plugin_clamav_address=127.0.0.1',\
  setvar:'tx.antivirus-plugin_clamav_port=3310',\
  setvar:'tx.antivirus-plugin_clamav_chunk_size=4096',\
  setvar:'tx.antivirus-plugin_clamav_network_timeout_seconds=2',\
  setvar:'tx.antivirus-plugin_clamav_max_file_size_bytes=1048576'"
